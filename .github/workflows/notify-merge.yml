name: ğŸ“¢ ãƒãƒ¼ã‚¸å®Œäº†é€šçŸ¥

on:
  pull_request:
    types: [closed]

jobs:
  notify-next-task:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: æ¬¡ã®ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
        id: next-task
        run: |
          NEXT_TASK=$(gh project item-list 1 --owner kawaka0001 --format json --limit 100 | \
            jq -r '.items[] | select(.status == "Todo") | "Issue #\(.content.number): \(.content.title)"' | head -1)
          echo "task=$NEXT_TASK" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Issueæ›´æ–°ï¼ˆå®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const issueNumbers = context.payload.pull_request.body.match(/#(\d+)/g);

            if (issueNumbers) {
              for (const issue of issueNumbers) {
                const num = issue.replace('#', '');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(num),
                  body: `âœ… PR #${prNumber} ãŒãƒãƒ¼ã‚¸ã•ã‚Œã¾ã—ãŸ\n\næ¬¡ã®ã‚¿ã‚¹ã‚¯ã¸é€²ã‚“ã§ãã ã•ã„ï¼š ${{ steps.next-task.outputs.task }}`
                });
              }
            }

      - name: GitHub Projectsã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        run: |
          echo "ğŸ“Š GitHub Projectsã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
